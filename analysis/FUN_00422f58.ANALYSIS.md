# FUN_00422f58 Analysis (draw_file)

**STATUS: FIXED in src/file_ops.c** (Phase 18)

## Function Identity

**Address:** 0x00422f58
**Disassembly label:** `draw_file+0xc`
**Source file:** `src/file_ops.c:446`
**Purpose:** Render individual file blocks with labels, spotlight effects

## Function Flow (from annotated assembly)

1. **Early exit checks** (lines 7-24)
   - Check render_flags at offset +40 (0x28)
   - Various bit tests for visibility/state

2. **Setup** (lines 37-77)
   - Load curcontext pointer
   - Load fsn_resources
   - pushmatrix()
   - v3f(file_x, file_y, 0) - translate to file position

3. **Label rendering** (lines 164-263)
   - cpack(0) - black color
   - pushmatrix()
   - Calculate text position based on file height
   - rotate(-camera_angle, 'x') - face camera
   - scale(text_scale) - from constant pool
   - draw_stroked_text(filename) - VECTOR FONT
   - popmatrix()

4. **3D block rendering** (lines 270-320)
   - zwritemask(0) - disable Z writes for transparent effect
   - pushmatrix()
   - scale(icon_size_multiplier)
   - draw_box_solid() - render 3D block
   - popmatrix()

5. **Spotlight effect** (lines 325-399)
   - get_item_bounds() - calculate bounds
   - scale calculations for spotlight
   - v3f(-0.5, -0.5, z) - spotlight cone base
   - draw_spotlight() - render selection beam
   - popmatrix()

6. **Stencil handling** (lines 403-454)
   - zwritemask(-1) - re-enable Z
   - stencil operations for selection masking
   - Additional draw_box_solid calls

## Ghidra Corruption Found

**Line 62-65 in decompiled C:**
```c
(float)((double)-*(float *)(iVar5 + 0x70) /
        (double)((ulonglong)(double)iVar2 & 0xffffffff00000000) - ...
```

**Line 98-101 in decompiled C:**
```c
(float)((double)((ulonglong)extraout_var << 0x20) /
       ((double)local_c - (double)local_4))
```

## Actual Assembly (correct behavior)

Looking at 423104-423138:
```asm
46283403    div.d $f16,$f6,$f8    # float division
8f998494    lw t9,-31596(gp)      # scale()
46208320    cvt.s.d $f12,$f16     # convert result
0320f809    jalr t9               # call scale()
```

The assembly shows proper float division (`div.d`), not bizarre bitwise AND operations.

## Fix Applied (Phase 18)

**file_ops.c:draw_file()** - FIXED

### Bug 1: Label Position Calculation (lines 493-498)
**Original corrupt:**
```c
dVar7 = (double)iVar2 * (double)CONCAT44(uVar6,0xeb851eb8);
translate((float)dVar7,
          (float)((double)-view_offset_x /
                  (double)((ulonglong)(double)iVar2 & 0xffffffff00000000) - ...
```

**Fixed:**
```c
label_x = (float)file_height * 0.46f;
label_y = -view_offset_x / (float)file_height - 0.6f;
translate(label_x, label_y, 0.03f);  /* Z offset from constant 0x3cf5c28f */
```

### Bug 2: Spotlight Scale Calculation (lines 524-527)
**Original corrupt:**
```c
scale((float)((double)((ulonglong)extraout_var << 0x20) /
             ((double)fStack_c - (double)fStack_4)),
      (float)((double)((ulonglong)extraout_var << 0x20) /
             ((double)fStack_10 - (double)fStack_8)));
```

**Fixed:**
```c
scale_x = (bounds_right - bounds_left);
scale_y = (bounds_top - bounds_bottom);
if (scale_x > 0.001f && scale_y > 0.001f) {
    scale(1.0f / scale_x, 1.0f / scale_y, 1.0f);
}
```

### Bug 3: Raw Hex as Translate Arg (line 523)
**Original:** `translate(0xbf000000, 0xbf000000);`
**Fixed:** `translate(-0.5f, -0.5f, 0.0f);`  /* 0xbf000000 = -0.5f IEEE 754 */

## Other Implementations

**draw_tree.c** - CLEAN (reimplemented independently)
- File block rendering uses proper float arithmetic
- Vector font labels working via draw_file_icon()
- Spotlight effect via spotlight() function

## GP Offset Map for FUN_00422f58

| Offset | Symbol |
|--------|--------|
| -30920 | gettextid |
| -32028 | popname? |
| -31560 | pushmatrix |
| -31584 | v3f |
| -31596 | scale |
| -31052 | draw_box_solid |
| -31528 | popmatrix |
| -31644 | cpack |
| -31592 | rotate |
| -31240 | draw_stroked_text |
| -32048 | zwritemask |
| -32044 | stencil |
| -30680 | get_item_bounds |
| -30676 | draw_spotlight |
| -30340 | curcontext_ptr |
| -30172 | fsn_resources |
| -30344 | color_palette |
| -32676 | const_pool |
